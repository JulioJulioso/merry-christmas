<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Virtual Profesional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }

        .loading-content {
            text-align: center;
            color: #e0e0e0;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #2a2a2a;
            border-right: 2px solid #404040;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            background: #333;
            border-bottom: 1px solid #404040;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #999;
        }

        .sidebar-content {
            padding: 20px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #404040;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-label {
            display: block;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 4px;
        }

        .input-field {
            width: 100%;
            padding: 8px 12px;
            background: #404040;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: #4CAF50;
            background: #4a4a4a;
        }

        .btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
        }

        .btn-secondary:hover {
            background: #777;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-full {
            width: 100%;
            margin-bottom: 8px;
        }

        .scene-list {
            list-style: none;
        }

        .scene-item {
            padding: 12px;
            background: #383838;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
            cursor: pointer;
            transition: background 0.2s;
        }

        .scene-item:hover {
            background: #444;
        }

        .scene-item.active {
            background: #4CAF50;
            color: white;
        }

        .scene-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .scene-type {
            font-size: 11px;
            color: #aaa;
        }

        .poi-list {
            list-style: none;
        }

        .poi-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #383838;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .poi-info {
            flex: 1;
        }

        .poi-title {
            font-weight: 600;
            color: #fff;
        }

        .poi-coords {
            color: #999;
            font-size: 10px;
        }

        .poi-actions {
            display: flex;
            gap: 4px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
        }

        .main-view {
            flex: 1;
            position: relative;
            background: #0f0f0f;
        }

        .viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .control-group {
            background: rgba(42, 42, 42, 0.9);
            border-radius: 6px;
            padding: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid #404040;
        }

        .toggle-sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: rgba(42, 42, 42, 0.9);
            border: 1px solid #404040;
            backdrop-filter: blur(10px);
        }

        .poi-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4CAF50;
            border: 3px solid white;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .poi-marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .poi-marker.info {
            background: #2196F3;
        }

        .poi-marker.link {
            background: #FF9800;
        }

        .poi-marker.model {
            background: #9C27B0;
        }

        .poi-tooltip {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 101;
        }

        .poi-marker:hover .poi-tooltip {
            opacity: 1;
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(42, 42, 42, 0.95);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #404040;
            backdrop-filter: blur(10px);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .info-panel.active {
            transform: translateY(0);
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .close-info {
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .close-info:hover {
            color: #fff;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .scene-selector {
            margin-bottom: 12px;
        }

        .export-section {
            border-top: 1px solid #404040;
            padding-top: 20px;
            margin-top: 20px;
        }

        .url-input {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .url-input input {
            flex: 1;
        }

        .asset-list {
            max-height: 200px;
            overflow-y: auto;
            background: #383838;
            border-radius: 4px;
            padding: 8px;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            border-bottom: 1px solid #444;
            font-size: 12px;
        }

        .asset-item:last-child {
            border-bottom: none;
        }

        .coordinate-display {
            background: #383838;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            color: #4CAF50;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                position: absolute;
                height: 100%;
                z-index: 2000;
            }
            
            .controls {
                right: 10px;
                top: 10px;
            }
            
            .info-panel {
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Cargando Tour Virtual</h3>
            <p>Preparando experiencia inmersiva...</p>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Tour Virtual Pro</div>
                <div class="sidebar-subtitle">Panel de Gestión</div>
            </div>
            
            <div class="sidebar-content">
                <!-- Gestión de Escenas -->
                <div class="section">
                    <div class="section-title">Escenas</div>
                    
                    <div class="input-group">
                        <label class="input-label">Nombre de la Escena</label>
                        <input type="text" class="input-field" id="sceneName" placeholder="Ej: Sala Principal">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Tipo de Contenido</label>
                        <select class="input-field" id="sceneType">
                            <option value="panorama">Panorama 360°</option>
                            <option value="model3d">Modelo 3D</option>
                            <option value="photo2d">Foto 2D</option>
                        </select>
                    </div>
                    
                    <div class="url-input">
                        <input type="text" class="input-field" id="sceneUrl" placeholder="URL del archivo">
                        <button class="btn btn-secondary" onclick="addAsset()">+</button>
                    </div>
                    
                    <button class="btn btn-full" onclick="addScene()">Agregar Escena</button>
                    
                    <ul class="scene-list" id="sceneList"></ul>
                </div>

                <!-- Gestión de POIs -->
                <div class="section">
                    <div class="section-title">Puntos de Interés (POIs)</div>
                    
                    <div class="input-group">
                        <label class="input-label">Título del POI</label>
                        <input type="text" class="input-field" id="poiTitle" placeholder="Ej: Información Principal">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Tipo de POI</label>
                        <select class="input-field" id="poiType">
                            <option value="info">Información (ℹ️)</option>
                            <option value="link">Enlace de Escena (🔗)</option>
                            <option value="model">Modelo 3D (📦)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Descripción/URL</label>
                        <textarea class="input-field" id="poiContent" rows="3" placeholder="Contenido del POI"></textarea>
                    </div>
                    
                    <div class="coordinate-display" id="coordinateDisplay">
                        Coordenadas: Haz clic en la escena
                    </div>
                    
                    <button class="btn btn-full" onclick="addPOI()" disabled id="addPoiBtn">Agregar POI</button>
                    
                    <ul class="poi-list" id="poiList"></ul>
                </div>

                <!-- Assets Externos -->
                <div class="section">
                    <div class="section-title">Assets Externos</div>
                    <div class="asset-list" id="assetList">
                        <div class="asset-item">
                            <span>📁 Assets guardados aparecerán aquí</span>
                        </div>
                    </div>
                </div>

                <!-- Exportar -->
                <div class="export-section">
                    <div class="section-title">Exportar Tour</div>
                    <button class="btn btn-full" onclick="exportTour()">Generar HTML</button>
                    <button class="btn btn-secondary btn-full" onclick="downloadConfig()">Descargar Config JSON</button>
                </div>
            </div>
        </div>

        <!-- Vista Principal -->
        <div class="main-view">
            <button class="btn toggle-sidebar" id="toggleSidebar" onclick="toggleSidebar()">☰</button>
            
            <div class="viewer-container">
                <div class="canvas-container" id="canvasContainer"></div>
            </div>

            <!-- Controles -->
            <div class="controls">
                <div class="control-group">
                    <label class="input-label">Escena Actual</label>
                    <select class="input-field scene-selector" id="currentScene" onchange="loadScene(this.value)">
                        <option value="">Seleccionar escena...</option>
                    </select>
                </div>
            </div>

            <!-- Panel de Información -->
            <div class="info-panel" id="infoPanel">
                <div class="info-header">
                    <div class="info-title" id="infoTitle">Título del POI</div>
                    <button class="close-info" onclick="closeInfo()">×</button>
                </div>
                <div class="info-content" id="infoContent">
                    Contenido del POI...
                </div>
            </div>
        </div>
    </div>

    <script>
        class VirtualTour {
            constructor() {
                this.scenes = [];
                this.currentScene = null;
                this.currentSceneIndex = -1;
                this.pois = {};
                this.assets = [];
                this.renderer = null;
                this.scene = null;
                this.camera = null;
                this.mesh = null;
                this.controls = null;
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.isMouseDown = false;
                this.clickCoordinates = null;
                
                this.init();
            }

            init() {
                this.setupRenderer();
                this.setupEventListeners();
                this.hideLoading();
            }

            setupRenderer() {
                const container = document.getElementById('canvasContainer');
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                container.appendChild(this.renderer.domElement);

                // Scene
                this.scene = new THREE.Scene();

                // Camera
                this.camera = new THREE.PerspectiveCamera(
                    75,
                    container.clientWidth / container.clientHeight,
                    0.1,
                    1000
                );

                // Controls básicos de mouse
                this.setupMouseControls();

                // Resize handler
                window.addEventListener('resize', () => this.onWindowResize());
                
                // Render loop
                this.animate();
            }

            setupMouseControls() {
                const canvas = this.renderer.domElement;
                let lastMouseX = 0;
                let lastMouseY = 0;
                let isMouseDown = false;

                canvas.addEventListener('mousedown', (event) => {
                    isMouseDown = true;
                    lastMouseX = event.clientX;
                    lastMouseY = event.clientY;
                    
                    // Para agregar POIs
                    this.updateCoordinates(event);
                });

                canvas.addEventListener('mousemove', (event) => {
                    if (isMouseDown) {
                        const deltaX = event.clientX - lastMouseX;
                        const deltaY = event.clientY - lastMouseY;
                        
                        this.camera.rotation.y -= deltaX * 0.005;
                        this.camera.rotation.x -= deltaY * 0.005;
                        
                        // Limitar rotación vertical
                        this.camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, this.camera.rotation.x));
                        
                        lastMouseX = event.clientX;
                        lastMouseY = event.clientY;
                    }
                });

                canvas.addEventListener('mouseup', () => {
                    isMouseDown = false;
                });

                // Zoom con rueda del mouse
                canvas.addEventListener('wheel', (event) => {
                    event.preventDefault();
                    const fov = this.camera.fov + event.deltaY * 0.05;
                    this.camera.fov = Math.max(10, Math.min(100, fov));
                    this.camera.updateProjectionMatrix();
                });
            }

            updateCoordinates(event) {
                const rect = this.renderer.domElement.getBoundingClientRect();
                this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                if (this.mesh && this.mesh.geometry) {
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersects = this.raycaster.intersectObject(this.mesh);
                    
                    if (intersects.length > 0) {
                        const point = intersects[0].point;
                        this.clickCoordinates = {
                            x: Math.round(event.clientX - rect.left),
                            y: Math.round(event.clientY - rect.top),
                            worldX: point.x.toFixed(3),
                            worldY: point.y.toFixed(3),
                            worldZ: point.z.toFixed(3)
                        };
                        
                        document.getElementById('coordinateDisplay').textContent = 
                            `Coordenadas: ${this.clickCoordinates.x}, ${this.clickCoordinates.y} (Mundo: ${this.clickCoordinates.worldX}, ${this.clickCoordinates.worldY}, ${this.clickCoordinates.worldZ})`;
                        
                        document.getElementById('addPoiBtn').disabled = false;
                    }
                }
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                this.renderer.render(this.scene, this.camera);
            }

            onWindowResize() {
                const container = document.getElementById('canvasContainer');
                this.camera.aspect = container.clientWidth / container.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(container.clientWidth, container.clientHeight);
            }

            setupEventListeners() {
                // Keyboard shortcuts
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Tab') {
                        event.preventDefault();
                        this.toggleSidebar();
                    }
                });
            }

            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }, 1000);
            }

            addScene(name, type, url) {
                const scene = {
                    id: Date.now(),
                    name: name || `Escena ${this.scenes.length + 1}`,
                    type: type || 'panorama',
                    url: url || '',
                    pois: []
                };

                this.scenes.push(scene);
                this.updateSceneList();
                this.updateSceneSelector();
                this.showMessage(`Escena "${scene.name}" agregada exitosamente`, 'success');
                
                return scene.id;
            }

            loadScene(sceneId) {
                if (!sceneId) return;
                
                const scene = this.scenes.find(s => s.id == sceneId);
                if (!scene) return;

                this.currentScene = scene;
                this.currentSceneIndex = this.scenes.indexOf(scene);

                // Limpiar escena anterior
                if (this.mesh) {
                    this.scene.remove(this.mesh);
                }

                // Cargar nueva escena según tipo
                switch (scene.type) {
                    case 'panorama':
                        this.loadPanorama(scene.url);
                        break;
                    case 'model3d':
                        this.loadModel3D(scene.url);
                        break;
                    case 'photo2d':
                        this.loadPhoto2D(scene.url);
                        break;
                }

                // Cargar POIs de la escena
                this.loadScenePOIs(scene.id);
                this.updatePOIList();
            }

            loadPanorama(imageUrl) {
                if (!imageUrl) {
                    imageUrl = 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="2048" height="1024" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <radialGradient id="bg" cx="50%" cy="50%">
                                    <stop offset="0%" style="stop-color:#4CAF50"/>
                                    <stop offset="100%" style="stop-color:#1a1a1a"/>
                                </radialGradient>
                            </defs>
                            <rect width="2048" height="1024" fill="url(#bg)"/>
                            <text x="1024" y="400" text-anchor="middle" fill="white" font-size="80" font-family="Arial">Panorama Demo</text>
                            <text x="1024" y="500" text-anchor="middle" fill="#e0e0e0" font-size="40" font-family="Arial">Agrega tu imagen 360°</text>
                            <text x="1024" y="600" text-anchor="middle" fill="#ccc" font-size="30" font-family="Arial">Haz clic para agregar POIs</text>
                        </svg>
                    `);
                }

                const loader = new THREE.TextureLoader();
                loader.crossOrigin = 'anonymous';
                
                loader.load(
                    imageUrl,
                    (texture) => {
                        const geometry = new THREE.SphereGeometry(500, 64, 32);
                        const material = new THREE.MeshBasicMaterial({
                            map: texture,
                            side: THREE.BackSide
                        });
                        
                        this.mesh = new THREE.Mesh(geometry, material);
                        this.scene.add(this.mesh);
                        
                        // Reset camera
                        this.camera.position.set(0, 0, 0);
                        this.camera.rotation.set(0, 0, 0);
                        
                        this.showMessage('Panorama cargado exitosamente', 'success');
                    },
                    undefined,
                    (error) => {
                        console.error('Error cargando panorama:', error);
                        this.showMessage('Error al cargar el panorama. Verifica la URL y que permita CORS.', 'error');
                        this.loadPanorama(); // Cargar demo
                    }
                );
            }

            loadModel3D(modelUrl) {
                // Implementación básica para modelos 3D
                // En producción se usaría GLTFLoader
                const geometry = new THREE.BoxGeometry(100, 100, 100);
                const material = new THREE.MeshPhongMaterial({ color: 0x4CAF50 });
                this.mesh = new THREE.Mesh(geometry, material);
                
                // Agregar luz
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(100, 100, 100);
                this.scene.add(light);
                
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                this.scene.add(ambientLight);
                
                this.scene.add(this.mesh);
                this.camera.position.set(0, 0, 200);
                
                this.showMessage('Modelo 3D demo cargado', 'success');
            }

            loadPhoto2D(imageUrl) {
                if (!imageUrl) {
                    imageUrl = 'data:image/svg+xml;base64,' + btoa(`
                        <svg width="1024" height="768" xmlns="http://www.w3.org/2000/svg">
                            <rect width="1024" height="768" fill="#2a2a2a"/>
                            <text x="512" y="300" text-anchor="middle" fill="white" font-size="60" font-family="Arial">Foto 2D Demo</text>
                            <text x="512" y="400" text-anchor="middle" fill="#e0e0e0" font-size="30" font-family="Arial">Agrega tu imagen 2D</text>
                        </svg>
                    `);
                }

                const loader = new THREE.TextureLoader();
                loader.crossOrigin = 'anonymous';
                
                loader.load(
                    imageUrl,
                    (texture) => {
                        const geometry = new THREE.PlaneGeometry(400, 300);
                        const material = new THREE.MeshBasicMaterial({ map: texture });
                        
                        this.mesh = new THREE.Mesh(geometry, material);
                        this.scene.add(this.mesh);
                        
                        this.camera.position.set(0, 0, 200);
                        this.camera.lookAt(0, 0, 0);
                        
                        this.showMessage('Foto 2D cargada exitosamente', 'success');
                    },
                    undefined,
                    (error) => {
                        console.error('Error cargando foto:', error);
                        this.showMessage('Error al cargar la foto. Verifica la URL.', 'error');
                        this.loadPhoto2D(); // Cargar demo
                    }
                );
            }

            addPOI(title, type, content, coordinates) {
                if (!this.currentScene) {
                    this.showMessage('Selecciona una escena primero', 'error');
                    return;
                }

                if (!coordinates && !this.clickCoordinates) {
                    this.showMessage('Haz clic en la escena para establecer coordenadas', 'error');
                    return;
                }

                const poi = {
                    id: Date.now(),
                    sceneId: this.currentScene.id,
                    title: title || 'POI sin título',
                    type: type || 'info',
                    content: content || '',
                    coordinates: coordinates || this.clickCoordinates
                };

                if (!this.pois[this.currentScene.id]) {
                    this.pois[this.currentScene.id] = [];
                }

                this.pois[this.currentScene.id].push(poi);
                this.createPOIMarker(poi);
                this.updatePOIList();
                this.showMessage(`POI "${poi.title}" agregado exitosamente`, 'success');

                // Reset coordinates
                this.clickCoordinates = null;
                document.getElementById('coordinateDisplay').textContent = 'Coordenadas: Haz clic en la escena';
                document.getElementById('addPoiBtn').disabled = true;

                return poi.id;
            }

            createPOIMarker(poi) {
                const marker = document.createElement('div');
                marker.className = `poi-marker ${poi.type}`;
                marker.style.left = poi.coordinates.x + 'px';
                marker.style.top = poi.coordinates.y + 'px';
                
                // Icono según tipo
                const icons = {
                    info: 'ℹ️',
                    link: '🔗',
                    model: '📦'
                };
                marker.innerHTML = icons[poi.type] || 'ℹ️';

                // Tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'poi-tooltip';
                tooltip.textContent = poi.title;
                marker.appendChild(tooltip);

                // Click handler
                marker.addEventListener('click', () => this.showPOIInfo(poi));

                document.getElementById('canvasContainer').appendChild(marker);
            }

            loadScenePOIs(sceneId) {
                // Limpiar marcadores existentes
                const markers = document.querySelectorAll('.poi-marker');
                markers.forEach(marker => marker.remove());

                // Cargar POIs de la escena
                if (this.pois[sceneId]) {
                    this.pois[sceneId].forEach(poi => this.createPOIMarker(poi));
                }
            }

            showPOIInfo(poi) {
                const panel = document.getElementById('infoPanel');
                const title = document.getElementById('infoTitle');
                const content = document.getElementById('infoContent');

                title.textContent = poi.title;
                
                if (poi.type === 'link') {
                    const targetScene = this.scenes.find(s => s.name === poi.content);
                    if (targetScene) {
                        content.innerHTML = `
                            <p>Enlace a escena: <strong>${poi.content}</strong></p>
                            <button class="btn" onclick="tour.loadScene(${targetScene.id})">Ir a escena</button>
                        `;
                    } else {
                        content.innerHTML = `<p><strong>Enlace:</strong> ${poi.content}</p>`;
                    }
                } else {
                    content.innerHTML = `<p>${poi.content}</p>`;
                }

                panel.classList.add('active');
            }

            updateSceneList() {
                const list = document.getElementById('sceneList');
                list.innerHTML = '';

                this.scenes.forEach(scene => {
                    const item = document.createElement('li');
                    item.className = 'scene-item';
                    if (this.currentScene && scene.id === this.currentScene.id) {
                        item.classList.add('active');
                    }

                    item.innerHTML = `
                        <div class="scene-title">${scene.name}</div>
                        <div class="scene-type">${scene.type} - ${this.pois[scene.id] ? this.pois[scene.id].length : 0} POIs</div>
                    `;

                    item.addEventListener('click', () => {
                        document.getElementById('currentScene').value = scene.id;
                        this.loadScene(scene.id);
                        this.updateSceneList();
                    });

                    list.appendChild(item);
                });
            }

            updateSceneSelector() {
                const selector = document.getElementById('currentScene');
                selector.innerHTML = '<option value="">Seleccionar escena...</option>';

                this.scenes.forEach(scene => {
                    const option = document.createElement('option');
                    option.value = scene.id;
                    option.textContent = scene.name;
                    selector.appendChild(option);
                });
            }

            updatePOIList() {
                const list = document.getElementById('poiList');
                list.innerHTML = '';

                if (this.currentScene && this.pois[this.currentScene.id]) {
                    this.pois[this.currentScene.id].forEach(poi => {
                        const item = document.createElement('li');
                        item.className = 'poi-item';
                        item.innerHTML = `
                            <div class="poi-info">
                                <div class="poi-title">${poi.title}</div>
                                <div class="poi-coords">${poi.type} - (${poi.coordinates.x}, ${poi.coordinates.y})</div>
                            </div>
                            <div class="poi-actions">
                                <button class="btn btn-small btn-danger" onclick="tour.removePOI(${poi.id})">×</button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                }
            }

            removePOI(poiId) {
                if (this.currentScene && this.pois[this.currentScene.id]) {
                    this.pois[this.currentScene.id] = this.pois[this.currentScene.id].filter(poi => poi.id !== poiId);
                    this.loadScenePOIs(this.currentScene.id);
                    this.updatePOIList();
                    this.showMessage('POI eliminado', 'success');
                }
            }

            exportTour() {
                const tourData = {
                    scenes: this.scenes,
                    pois: this.pois,
                    assets: this.assets,
                    metadata: {
                        created: new Date().toISOString(),
                        version: '2.0'
                    }
                };

                const htmlContent = this.generateHTML(tourData);
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tour-virtual.html';
                a.click();
                URL.revokeObjectURL(url);

                this.showMessage('Tour HTML generado y descargado', 'success');
            }

            generateHTML(tourData) {
                return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Virtual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* CSS minificado del tour */
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #1a1a1a; color: #e0e0e0; overflow: hidden; }
        .viewer { width: 100vw; height: 100vh; position: relative; }
        .controls { position: absolute; top: 20px; right: 20px; z-index: 1000; }
        .btn { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .poi-marker { position: absolute; width: 40px; height: 40px; border-radius: 50%; background: #4CAF50; border: 3px solid white; cursor: pointer; transform: translate(-50%, -50%); z-index: 100; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; }
        .poi-marker.info { background: #2196F3; }
        .poi-marker.link { background: #FF9800; }
        .poi-marker.model { background: #9C27B0; }
        .info-panel { position: absolute; bottom: 20px; left: 20px; right: 20px; background: rgba(42, 42, 42, 0.95); border-radius: 8px; padding: 20px; transform: translateY(100%); transition: transform 0.3s ease; z-index: 1000; }
        .info-panel.active { transform: translateY(0); }
    </style>
</head>
<body>
    <div class="viewer">
        <div id="canvasContainer"></div>
        <div class="controls">
            <select id="sceneSelector" class="btn">
                ${tourData.scenes.map(scene => `<option value="${scene.id}">${scene.name}</option>`).join('')}
            </select>
        </div>
        <div class="info-panel" id="infoPanel">
            <h3 id="infoTitle">Título</h3>
            <div id="infoContent">Contenido</div>
            <button class="btn" onclick="closeInfo()">Cerrar</button>
        </div>
    </div>
    <script>
        // JavaScript del tour minificado
        const tourData = ${JSON.stringify(tourData)};
        
        class SimpleTour {
            constructor() {
                this.scenes = tourData.scenes;
                this.pois = tourData.pois;
                this.currentScene = null;
                this.init();
            }
            
            init() {
                // Implementación básica del reproductor
                const container = document.getElementById('canvasContainer');
                this.renderer = new THREE.WebGLRenderer();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(this.renderer.domElement);
                
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                
                if (this.scenes.length > 0) {
                    this.loadScene(this.scenes[0].id);
                }
                
                this.setupControls();
                this.animate();
            }
            
            loadScene(sceneId) {
                const scene = this.scenes.find(s => s.id == sceneId);
                if (!scene) return;
                
                this.currentScene = scene;
                this.loadPanorama(scene.url);
                this.loadPOIs(sceneId);
            }
            
            loadPanorama(url) {
                if (!url) return;
                
                const loader = new THREE.TextureLoader();
                loader.load(url, (texture) => {
                    if (this.mesh) this.scene.remove(this.mesh);
                    
                    const geometry = new THREE.SphereGeometry(500, 64, 32);
                    const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.BackSide });
                    this.mesh = new THREE.Mesh(geometry, material);
                    this.scene.add(this.mesh);
                });
            }
            
            loadPOIs(sceneId) {
                document.querySelectorAll('.poi-marker').forEach(m => m.remove());
                
                if (this.pois[sceneId]) {
                    this.pois[sceneId].forEach(poi => {
                        const marker = document.createElement('div');
                        marker.className = 'poi-marker ' + poi.type;
                        marker.style.left = poi.coordinates.x + 'px';
                        marker.style.top = poi.coordinates.y + 'px';
                        marker.innerHTML = poi.type === 'info' ? 'ℹ️' : poi.type === 'link' ? '🔗' : '📦';
                        marker.onclick = () => this.showPOI(poi);
                        document.getElementById('canvasContainer').appendChild(marker);
                    });
                }
            }
            
            showPOI(poi) {
                document.getElementById('infoTitle').textContent = poi.title;
                document.getElementById('infoContent').innerHTML = poi.content;
                document.getElementById('infoPanel').classList.add('active');
            }
            
            setupControls() {
                const canvas = this.renderer.domElement;
                let isMouseDown = false;
                let lastX = 0, lastY = 0;
                
                canvas.onmousedown = (e) => { isMouseDown = true; lastX = e.clientX; lastY = e.clientY; };
                canvas.onmouseup = () => isMouseDown = false;
                canvas.onmousemove = (e) => {
                    if (isMouseDown) {
                        this.camera.rotation.y -= (e.clientX - lastX) * 0.005;
                        this.camera.rotation.x -= (e.clientY - lastY) * 0.005;
                        lastX = e.clientX; lastY = e.clientY;
                    }
                };
                
                document.getElementById('sceneSelector').onchange = (e) => this.loadScene(e.target.value);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        function closeInfo() {
            document.getElementById('infoPanel').classList.remove('active');
        }
        
        new SimpleTour();
    </script>
</body>
</html>`;
            }

            downloadConfig() {
                const config = {
                    scenes: this.scenes,
                    pois: this.pois,
                    assets: this.assets
                };

                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tour-config.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            showMessage(message, type = 'info') {
                // Crear o actualizar mensaje
                let messageEl = document.querySelector('.message');
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.className = 'message';
                    document.querySelector('.sidebar-content').prepend(messageEl);
                }

                messageEl.className = `${type}-message`;
                messageEl.textContent = message;

                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.remove();
                    }
                }, 3000);
            }

            addAsset(url, name) {
                if (!url) return;
                
                const asset = {
                    id: Date.now(),
                    name: name || url.split('/').pop(),
                    url: url,
                    type: this.getAssetType(url)
                };

                this.assets.push(asset);
                this.updateAssetList();
                return asset;
            }

            getAssetType(url) {
                const ext = url.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'webp'].includes(ext)) return 'image';
                if (['gltf', 'glb', 'obj'].includes(ext)) return 'model';
                if (['mp4', 'webm'].includes(ext)) return 'video';
                return 'other';
            }

            updateAssetList() {
                const list = document.getElementById('assetList');
                if (this.assets.length === 0) {
                    list.innerHTML = '<div class="asset-item"><span>📁 No hay assets guardados</span></div>';
                    return;
                }

                list.innerHTML = this.assets.map(asset => `
                    <div class="asset-item">
                        <span>${asset.type === 'image' ? '🖼️' : asset.type === 'model' ? '📦' : '📄'} ${asset.name}</span>
                        <button class="btn btn-small btn-danger" onclick="tour.removeAsset(${asset.id})">×</button>
                    </div>
                `).join('');
            }

            removeAsset(assetId) {
                this.assets = this.assets.filter(asset => asset.id !== assetId);
                this.updateAssetList();
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('collapsed');
            }
        }

        // Instancia global
        let tour;

        // Funciones globales para los botones
        function addScene() {
            const name = document.getElementById('sceneName').value;
            const type = document.getElementById('sceneType').value;
            const url = document.getElementById('sceneUrl').value;

            if (!name) {
                tour.showMessage('Ingresa un nombre para la escena', 'error');
                return;
            }

            tour.addScene(name, type, url);
            
            // Limpiar campos
            document.getElementById('sceneName').value = '';
            document.getElementById('sceneUrl').value = '';
        }

        function addPOI() {
            const title = document.getElementById('poiTitle').value;
            const type = document.getElementById('poiType').value;
            const content = document.getElementById('poiContent').value;

            if (!title) {
                tour.showMessage('Ingresa un título para el POI', 'error');
                return;
            }

            tour.addPOI(title, type, content);
            
            // Limpiar campos
            document.getElementById('poiTitle').value = '';
            document.getElementById('poiContent').value = '';
        }

        function addAsset() {
            const url = document.getElementById('sceneUrl').value;
            if (!url) {
                tour.showMessage('Ingresa una URL para el asset', 'error');
                return;
            }

            tour.addAsset(url);
            tour.showMessage('Asset agregado a la lista', 'success');
        }

        function exportTour() {
            tour.exportTour();
        }

        function downloadConfig() {
            tour.downloadConfig();
        }

        function closeInfo() {
            document.getElementById('infoPanel').classList.remove('active');
        }

        function toggleSidebar() {
            tour.toggleSidebar();
        }

        function loadScene(sceneId) {
            tour.loadScene(sceneId);
        }

        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', () => {
            tour = new VirtualTour();
        });
    </script>
</body>
</html>
